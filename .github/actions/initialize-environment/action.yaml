name: Initialize Environment

description: Initialization steps for kagent actions

runs:
  using: "composite"
  steps:
    - name: Cancel Previous Actions
      uses: styfle/cancel-workflow-action@85880fa0301c86cca9da44039ee3bb12d3bedbfa # 0.12.1
      with:
        access_token: ${{ github.token }}
    - name: Free disk space
      shell: bash
      run: |
        echo "Before clearing disk space:"
        df -h
        docker system df -v

        # https://github.com/actions/runner-images/discussions/3242 github runners are bad at cleanup
        echo "Removing large packages"
        sudo apt-get remove -y '^dotnet-.*' || true
        sudo apt-get remove -y '^llvm-.*' || true
        sudo apt-get remove -y 'php.*' || true
        sudo apt-get remove -y '^mongodb-.*' || true
        sudo apt-get remove -y '^mysql-.*' || true
        sudo apt-get remove -y azure-cli google-chrome-stable firefox powershell mono-devel libgl1-mesa-dri || true
        sudo apt-get autoremove -y || true
        sudo apt-get clean -y || true
        echo "Done removing large packages"

        # Clean up pre-installed tools
        # For some reason, GHA often takes minutes (up to 20min observed) to clean up somehow.
        # Presumably this is due to a slow disk?
        function clean-dir() {
          echo "Cleaning $1"
          time sudo rm -rf "$1" || true
        }
        # These two were found to take very very long. Even though its large, its not worth the cost
        # clean-dir /usr/local/lib/android  # 8.9gb
        # clean-dir $AGENT_TOOLSDIRECTORY  # 5.6gb
        clean-dir /usr/share/dotnet  # 3.4gb
        clean-dir /usr/share/swift  # 3.1gb
        clean-dir /usr/local/.ghcup  # 6.3gb
        clean-dir /usr/local/share/powershell  # 1.2gb
        clean-dir /usr/local/share/chromium  # 600mb

        # Clean up images
        docker image rm node:18 || true
        docker image rm node:18-alpine || true
        docker image rm node:20 || true
        docker image rm node:20-alpine || true
        # remove the dangling images and containers
        docker images | tail -n +2 | awk '$1 == "<none>" {print $3}' | xargs --no-run-if-empty docker rmi
        docker ps -a | tail -n +2 | awk '$2 ~ "^[0-9a-f]+$" {print $1}' | xargs --no-run-if-empty docker rm --volumes=true

        # Clean up Docker
        docker system prune -f || true

        echo "After clearing disk space:"
        df -h
        docker system df -v
