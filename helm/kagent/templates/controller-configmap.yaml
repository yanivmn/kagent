apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "kagent.fullname" . }}-controller
  namespace: {{ include "kagent.namespace" . }}
  labels:
    {{- include "kagent.controller.labels" . | nindent 4 }}
data:
  A2A_BASE_URL: {{ include "kagent.a2aBaseUrl" . | quote }}
  DATABASE_TYPE: {{ .Values.database.type | quote }}
  DEFAULT_MODEL_CONFIG_NAME: {{ include "kagent.defaultModelConfigName" . | quote }}
  KAGENT_CONTROLLER_NAME: {{ include "kagent.fullname" . }}-controller
  IMAGE_PULL_POLICY: {{ .Values.controller.agentImage.pullPolicy | default .Values.imagePullPolicy | quote }}
  {{- if and .Values.controller.agentImage.pullSecret (not (eq .Values.controller.agentImage.pullSecret "")) }}
  IMAGE_PULL_SECRET: {{ .Values.controller.agentImage.pullSecret | quote }}
  {{- end }}
  IMAGE_REGISTRY: {{ .Values.controller.agentImage.registry | default .Values.registry  | quote }}
  IMAGE_REPOSITORY: {{ .Values.controller.agentImage.repository | quote }}
  IMAGE_TAG: {{ coalesce .Values.controller.agentImage.tag .Values.tag .Chart.Version | quote }}
  LEADER_ELECT: {{ include "kagent.leaderElectionEnabled" . | quote }}
  # OpenTelemetry Configuration
  OTEL_TRACING_ENABLED: {{ .Values.otel.tracing.enabled | quote }}
  OTEL_LOGGING_ENABLED: {{ .Values.otel.logging.enabled | quote }}
  {{- $tracesEndpoint := .Values.otel.tracing.exporter.otlp.endpoint }}
  {{- $logsEndpoint := .Values.otel.logging.exporter.otlp.endpoint }}
  {{- if and $tracesEndpoint $logsEndpoint (eq $tracesEndpoint $logsEndpoint) }}
  # Using unified OTEL endpoint (same for traces and logs)
  OTEL_EXPORTER_OTLP_ENDPOINT: {{ $tracesEndpoint | quote }}
  OTEL_EXPORTER_OTLP_TRACES_INSECURE: {{ .Values.otel.tracing.exporter.otlp.insecure | quote }}
  OTEL_EXPORTER_OTLP_TRACES_TIMEOUT: {{ .Values.otel.tracing.exporter.otlp.timeout | quote }}
  OTEL_EXPORTER_OTLP_LOGS_INSECURE: {{ .Values.otel.logging.exporter.otlp.insecure | quote }}
  OTEL_EXPORTER_OTLP_LOGS_TIMEOUT: {{ .Values.otel.logging.exporter.otlp.timeout | quote }}
  {{- else }}
  # Using separate endpoints for traces and logs
  {{- if $tracesEndpoint }}
  OTEL_EXPORTER_OTLP_TRACES_ENDPOINT: {{ $tracesEndpoint | quote }}
  OTEL_EXPORTER_OTLP_TRACES_INSECURE: {{ .Values.otel.tracing.exporter.otlp.insecure | quote }}
  OTEL_EXPORTER_OTLP_TRACES_TIMEOUT: {{ .Values.otel.tracing.exporter.otlp.timeout | quote }}
  {{- end }}
  {{- if $logsEndpoint }}
  OTEL_EXPORTER_OTLP_LOGS_ENDPOINT: {{ $logsEndpoint | quote }}
  OTEL_EXPORTER_OTLP_LOGS_INSECURE: {{ .Values.otel.logging.exporter.otlp.insecure | quote }}
  OTEL_EXPORTER_OTLP_LOGS_TIMEOUT: {{ .Values.otel.logging.exporter.otlp.timeout | quote }}
  {{- end }}
  {{- end }}
  {{- if .Values.proxy.url }}
  PROXY_URL: {{ .Values.proxy.url | quote }}
  {{- end }}
  {{- if eq .Values.database.type "sqlite" }}
  SQLITE_DATABASE_PATH: /sqlite-volume/{{ .Values.database.sqlite.databaseName }}
  {{- else if and (eq .Values.database.type "postgres") (not (eq .Values.database.postgres.url "")) }}
  POSTGRES_DATABASE_URL: {{ .Values.database.postgres.url | quote }}
  {{- end }}
  STREAMING_INITIAL_BUF_SIZE: {{ .Values.controller.streaming.initialBufSize | quote }}
  STREAMING_MAX_BUF_SIZE: {{ .Values.controller.streaming.maxBufSize | quote }}
  STREAMING_TIMEOUT: {{ .Values.controller.streaming.timeout | quote }}
  WATCH_NAMESPACES: {{ include "kagent.watchNamespaces" . | quote }}
  ZAP_LOG_LEVEL: {{ .Values.controller.loglevel | quote }}
