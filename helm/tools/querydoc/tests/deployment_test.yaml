suite: test querydoc deployment
templates:
  - deployment.yaml
tests:
  - it: should render deployment with default values
    asserts:
      - isKind:
          of: Deployment
      - equal:
          path: metadata.name
          value: RELEASE-NAME-querydoc
      - equal:
          path: spec.replicas
          value: 1
      - hasDocuments:
          count: 1

  - it: should render deployment with custom replica count
    set:
      replicaCount: 2
    asserts:
      - equal:
          path: spec.replicas
          value: 2

  - it: should have correct container image
    asserts:
      - equal:
          path: spec.template.spec.containers[0].name
          value: querydoc
      - equal:
          path: spec.template.spec.containers[0].image
          value: ghcr.io/kagent-dev/doc2vec/mcp:1.1.7

  - it: should use custom image tag when set
    set:
      image:
        tag: "v2.0.0"
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: ghcr.io/kagent-dev/doc2vec/mcp:v2.0.0

  - it: should have correct service account name
    asserts:
      - equal:
          path: spec.template.spec.serviceAccountName
          value: RELEASE-NAME-querydoc

  - it: should have correct container port
    asserts:
      - equal:
          path: spec.template.spec.containers[0].ports[0].containerPort
          value: 8080

  - it: should have correct labels
    asserts:
      - equal:
          path: metadata.labels["app.kubernetes.io/name"]
          value: querydoc
      - equal:
          path: metadata.labels["app.kubernetes.io/instance"]
          value: RELEASE-NAME
      - equal:
          path: spec.template.metadata.labels["app.kubernetes.io/name"]
          value: querydoc
      - equal:
          path: spec.template.metadata.labels["app.kubernetes.io/instance"]
          value: RELEASE-NAME

  - it: should set nodeSelector
    set:
        nodeSelector:
          role: AI
    asserts:
      - equal:
          path: spec.template.spec.nodeSelector
          value:
            role: AI

  - it: should set tolerations
    set:
        tolerations:
          - key: role
            operator: Equal
            value: AI
            effect: NoSchedule
    asserts:
      - contains:
          any: true
          path: spec.template.spec.tolerations
          content:
            key: role
            value: AI
            effect: NoSchedule
            operator: Equal